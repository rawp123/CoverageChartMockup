<!-- Modules/CoverageChart/CoverageChartDemo.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coverage Chart Demo</title>
  <link rel="stylesheet" href="/Modules/CoverageChart/CoverageChart.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div class="title">
        <h1>Coverage Tower</h1>
        <div class="subtitle">Floating tower (per year) with Carrier / Carrier Group / Availability views</div>
        <div class="note">Carrier view colors are by Carrier Group (same group shares the same color).</div>
      </div>

      <div class="controls">
        <div class="controlBar" aria-label="Primary Controls">
          <div class="controlPanel controlPanel--view">
            <div class="controlBlock">
              <label for="viewSelect">View</label>
              <select id="viewSelect">
                <option value="carrier">Carrier</option>
                <option value="carrierGroup">Carrier Group</option>
                <option value="availability">Availability</option>
              </select>
            </div>
          </div>

          <div class="controlPanel controlPanel--years">
            <div class="inlinePair">
              <div class="controlBlock">
                <label for="startYearSelect">Start Year</label>
                <select id="startYearSelect">
                  <option value="">All</option>
                </select>
              </div>
              <div class="controlBlock">
                <label for="endYearSelect">End Year</label>
                <select id="endYearSelect">
                  <option value="">All</option>
                </select>
              </div>
            </div>
          </div>

          <div class="controlPanel controlPanel--zoom">
            <div class="inlinePair">
              <div class="controlBlock">
                <label for="zoomMinInput">Zoom Min ($)</label>
                <input id="zoomMinInput" type="text" inputmode="numeric" placeholder="0" />
              </div>
              <div class="controlBlock">
                <label for="zoomMaxInput">Zoom Max ($)</label>
                <input id="zoomMaxInput" type="text" inputmode="numeric" placeholder="Auto" />
              </div>
            </div>
          </div>

          <div class="controlPanel controlPanel--reset">
            <button type="button" id="resetAll" class="primaryBtn">Reset All</button>
          </div>
        </div>

        <div class="filterBar" aria-label="Focus Filters">
          <div class="controlPanel">
            <div class="controlBlock">
              <label for="carrierDropdown">Carrier (Multi)</label>
              <details id="carrierDropdown" class="multiDropdown">
                <summary class="multiDropdownSummary">
                  <span id="carrierDropdownLabel">All carriers</span>
                </summary>
                <div id="carrierDropdownMenu" class="multiDropdownMenu" role="group" aria-label="Carrier filters"></div>
              </details>
            </div>
          </div>

          <div class="controlPanel">
            <div class="controlBlock">
              <label for="carrierGroupDropdown">Carrier Group (Multi)</label>
              <details id="carrierGroupDropdown" class="multiDropdown">
                <summary class="multiDropdownSummary">
                  <span id="carrierGroupDropdownLabel">All carrier groups</span>
                </summary>
                <div id="carrierGroupDropdownMenu" class="multiDropdownMenu" role="group" aria-label="Carrier group filters"></div>
              </details>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="content">
      <div class="chartWrap">
        <div class="chartHint">Scroll to pan. Use <kbd>Shift</kbd> + wheel to scroll horizontally. Use <kbd>Ctrl/Cmd</kbd> + wheel to zoom the x-axis.</div>
        <div class="chartViewport">
          <div class="chartSurface">
            <canvas id="coverageCanvas"></canvas>
          </div>
        </div>
      </div>
      <pre id="errorBox" class="error" style="display:none;"></pre>
    </main>
  </div>

  <script type="module">
    import {
      renderCoverageChart,
      setView,
      getFilterOptions,
      getYearBounds,
      setYearRange,
      resetYearRange,
      setEntityFilters,
      resetEntityFilters,
      setZoomRange,
      resetZoomRange
    } from "/Modules/CoverageChart/CoverageChart.js";

    function showError(err) {
      const box = document.getElementById("errorBox");
      box.style.display = "block";
      box.textContent =
        "ERROR:\\n" + (err?.stack || err?.message || String(err)) +
        "\\n\\nQuick checks:" +
        "\\n- Chart.js loaded (CDN)" +
        "\\n- CSV URLs correct (PolicyLimits, PolicyDates, Policy, Carrier, CarrierGroup)" +
        "\\n- Server is serving /data and /Modules";
    }

    async function init() {
      try {
        await renderCoverageChart({
          canvasId: "coverageCanvas",
          csvUrl: "/data/OriginalFiles/tblPolicyLimits.csv",
          initialView: "carrier",
          barThickness: "flex",
          categorySpacing: 1.0,
          tooltipMaxParticipants: 50
        });

        const sel = document.getElementById("viewSelect");
        sel.addEventListener("change", (e) => setView(e.target.value));

        const startYearSelect = document.getElementById("startYearSelect");
        const endYearSelect = document.getElementById("endYearSelect");
        const carrierDropdownMenu = document.getElementById("carrierDropdownMenu");
        const carrierGroupDropdownMenu = document.getElementById("carrierGroupDropdownMenu");
        const carrierDropdownLabel = document.getElementById("carrierDropdownLabel");
        const carrierGroupDropdownLabel = document.getElementById("carrierGroupDropdownLabel");
        const zoomMinInput = document.getElementById("zoomMinInput");
        const zoomMaxInput = document.getElementById("zoomMaxInput");
        const resetAllBtn = document.getElementById("resetAll");

        const bounds = getYearBounds();
        if (bounds.minYear !== null && bounds.maxYear !== null) {
          for (let year = bounds.minYear; year <= bounds.maxYear; year++) {
            const a = document.createElement("option");
            a.value = String(year);
            a.textContent = String(year);
            startYearSelect.appendChild(a);

            const b = document.createElement("option");
            b.value = String(year);
            b.textContent = String(year);
            endYearSelect.appendChild(b);
          }
        }

        const filterOptions = getFilterOptions();
        function buildCheckboxMenu(container, values, inputName) {
          container.innerHTML = "";
          for (const value of values) {
            const row = document.createElement("label");
            row.className = "multiOption";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.name = inputName;
            cb.value = value;

            const text = document.createElement("span");
            text.textContent = value;

            row.appendChild(cb);
            row.appendChild(text);
            container.appendChild(row);
          }
        }

        buildCheckboxMenu(carrierDropdownMenu, filterOptions.carriers, "carrier_filter");
        buildCheckboxMenu(carrierGroupDropdownMenu, filterOptions.carrierGroups, "carrier_group_filter");

        function applyYearFilters() {
          const toYear = (v) => {
            if (v === null || v === undefined || String(v).trim() === "") return null;
            const n = Number.parseInt(String(v), 10);
            return Number.isFinite(n) ? n : null;
          };
          const start = toYear(startYearSelect.value);
          const end = toYear(endYearSelect.value);
          const boundsNow = getYearBounds();
          const minBound = Number.isFinite(boundsNow.minYear) ? boundsNow.minYear : null;
          const maxBound = Number.isFinite(boundsNow.maxYear) ? boundsNow.maxYear : null;

          // Always pass concrete bounds to avoid any open-ended interpretation drift.
          const effectiveStart = start !== null ? start : minBound;
          const effectiveEnd = end !== null ? end : maxBound;

          if (effectiveStart === null && effectiveEnd === null) {
            resetYearRange();
            return;
          }
          setYearRange(effectiveStart, effectiveEnd);
        }

        function applyZoomFilters() {
          setZoomRange(zoomMinInput.value, zoomMaxInput.value);
        }

        function selectedValuesFromCheckboxMenu(container) {
          return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map((el) => el.value);
        }

        function updateDropdownLabel(labelEl, values, allText, singularNoun) {
          if (!values.length) {
            labelEl.textContent = allText;
            return;
          }
          if (values.length === 1) {
            labelEl.textContent = values[0];
            return;
          }
          labelEl.textContent = `${values.length} ${singularNoun}s selected`;
        }

        function applyEntityFilters() {
          const carriers = selectedValuesFromCheckboxMenu(carrierDropdownMenu);
          const carrierGroups = selectedValuesFromCheckboxMenu(carrierGroupDropdownMenu);
          updateDropdownLabel(carrierDropdownLabel, carriers, "All carriers", "carrier");
          updateDropdownLabel(carrierGroupDropdownLabel, carrierGroups, "All carrier groups", "group");
          setEntityFilters({
            carriers,
            carrierGroups
          });
        }

        startYearSelect.addEventListener("input", applyYearFilters);
        startYearSelect.addEventListener("change", applyYearFilters);
        startYearSelect.addEventListener("blur", applyYearFilters);
        endYearSelect.addEventListener("input", applyYearFilters);
        endYearSelect.addEventListener("change", applyYearFilters);
        endYearSelect.addEventListener("blur", applyYearFilters);

        zoomMinInput.addEventListener("change", applyZoomFilters);
        zoomMaxInput.addEventListener("change", applyZoomFilters);
        zoomMinInput.addEventListener("blur", applyZoomFilters);
        zoomMaxInput.addEventListener("blur", applyZoomFilters);
        carrierDropdownMenu.addEventListener("change", applyEntityFilters);
        carrierGroupDropdownMenu.addEventListener("change", applyEntityFilters);

        function resetEntityFilterUI() {
          for (const cb of carrierDropdownMenu.querySelectorAll('input[type="checkbox"]')) cb.checked = false;
          for (const cb of carrierGroupDropdownMenu.querySelectorAll('input[type="checkbox"]')) cb.checked = false;
          updateDropdownLabel(carrierDropdownLabel, [], "All carriers", "carrier");
          updateDropdownLabel(carrierGroupDropdownLabel, [], "All carrier groups", "group");
        }

        resetAllBtn.addEventListener("click", () => {
          startYearSelect.value = "";
          endYearSelect.value = "";
          zoomMinInput.value = "";
          zoomMaxInput.value = "";
          resetEntityFilterUI();
          resetYearRange();
          resetZoomRange();
          resetEntityFilters();
        });
      } catch (e) {
        showError(e);
      }
    }

    init();
  </script>
</body>
</html>
